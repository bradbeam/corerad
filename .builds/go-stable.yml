image: archlinux
packages:
  - go
sources:
  - https://github.com/mdlayher/corerad
environment:
  GO111MODULE: "on"
tasks:
  - build: |
      go version
      go get golang.org/x/lint/golint
      go get honnef.co/go/tools/cmd/staticcheck
      cd corerad/
      ./.cibuild.sh
      go vet ./...
      /home/build/go/bin/staticcheck ./...
      /home/build/go/bin/golint -set_exit_status . ./cmd/... ./internal/...
      go test -mod vendor -v -race ./...
      # Run tests which require CAP_NET_RAW and a test veth pair. DAD is disabled
      # on the veth links so they are ready when the tests begin.
      sudo ip link add cradveth0 type veth peer name cradveth1
      echo 0 | sudo tee /proc/sys/net/ipv6/conf/cradveth0/accept_dad
      echo 0 | sudo tee /proc/sys/net/ipv6/conf/cradveth1/accept_dad
      # Forwarding is enabled so we can specify router lifetime.
      echo 1 | sudo tee /proc/sys/net/ipv6/conf/cradveth0/forwarding
      sudo ip link set up cradveth0
      sudo ip link set up cradveth1
      go test -c -mod vendor -race ./internal/corerad/
      sudo ./corerad.test -test.v -test.run TestAdvertiser
      # Ensure a valid and sane configuration can be generated.
      go build -mod vendor ./cmd/corerad/
      go get github.com/BurntSushi/toml/cmd/tomlv
      ./corerad -init
      /home/build/go/bin/tomlv ./corerad.toml
